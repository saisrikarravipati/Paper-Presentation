TEMP CODE --

I want you to think like a senior software engineer and help me with below tasks. be very mindful and take your time but give me error free and tested code.
Think like a senior software engineer who is expert in python, Open policy agent, system design and design patterns. Now i need you to help me with below tasks


1) I want to add 2 flags and 1 value to the below response in the code such that

flag 1 - name = is_repo_net_new, the boolean value for this flag will be true if repoCreationDate is after "2024-04-01T00:00:00Z"
flag 2 - name = is_repo_fully_enforced, the boolean value for this flag will be true if repoCreationDate is after "2024-04-01T00:00:00Z" and it has been 60 days since repo creation
value 1 - name = full_enforcement_Date, this will be a date value such that it is repo creation date + 60 days

2) Explain what you are doing so i can understand it, add comments wherever needed

3) Implement unit tests for the new logic such that all edge cases are covered, this will be a separate file named scope_test.rego

4) test it yourself locally extensively





-------------------------


package policy.enforcement.scope

import data.policy.lib.data
import rego.v1

# Constants
IN_SCOPE_CUTOFF_DATE := "2024-05-15T00:00:00Z"
NET_NEW_CUTOFF_DATE := "2024-04-01T00:00:00Z"
# Define enforcement duration as 60 days in nanoseconds.
ENFORCEMENT_DURATION_NS := 60 * 24 * 3600 * 1000000000

# A repository is considered "net new" if its creation date is after NET_NEW_CUTOFF_DATE.
net_new_cutoff_ns := time.parse_rfc3339_ns(NET_NEW_CUTOFF_DATE)

# Calculate the repository creation timestamp.
repo_creation_timestamp := parsed_timestamp if {
    parsed_timestamp := time.parse_ns("2006-01-02T15:04:05", input.repoCreationDate)
} else := time.parse_rfc3339_ns(input.repoCreationDate)

###############################################################################
# Current Time (Default Only)
###############################################################################
# In production, use the system time. In tests, we override this via "with".
current_time_ns = time.now_ns()

###############################################################################
# New Computed Values and Flags
###############################################################################

# Flag 1: is_repo_net_new
is_repo_net_new = value if {
    value = repo_creation_timestamp > net_new_cutoff_ns
}

# Compute the full enforcement date (repo creation + 60 days) formatted as ISO8601.
full_enforcement_Date = enforcement_date if {
    enforcement_due_ns = time.add_ns(repo_creation_timestamp, ENFORCEMENT_DURATION_NS)
    enforcement_date = time.format_ns(enforcement_due_ns, "2006-01-02T15:04:05Z07:00")
}

# Flag 2: is_repo_fully_enforced
# We avoid using the "and" operator by using an if-else chain.
is_repo_fully_enforced = result if {
    # Both conditions must be met:
    repo_creation_timestamp > net_new_cutoff_ns
    current_time_ns >= time.add_ns(repo_creation_timestamp, ENFORCEMENT_DURATION_NS)
    result = true
} else = result if {
    result = false
}

###############################################################################
# Existing Policy Logic
###############################################################################

results := response if {
    all_decisions := [decision |
        some res in scope_results
        decision := res.decision
    ]
    all_messages := [message |
        some res in scope_results
        message := res.message
    ]
    decision := make_decision(all_decisions)
    response := {
        "policy_name": "Enforcement Scope policy",
        "decision": decision,
        "messages": all_messages,
        "isRepoInEtbScope": ETBinScope,
        "is_repo_net_new": is_repo_net_new,
        "is_repo_fully_enforced": is_repo_fully_enforced,
        "full_enforcement_Date": full_enforcement_Date,
    }
}

scope_results contains decision if {
    in_scope_pipeline = true
    decision := {
        "message": "pass repo app type, date, and flavor in scope",
        "policy_name": "Enforcement Scope policy",
        "decision": "true",
    }
}

scope_results contains decision if {
    ETBinScope
    decision := {
        "message": "pass repo in ETB list",
        "policy_name": "Enforcement Scope policy",
        "decision": "true",
    }
}

scope_results contains decision if {
    not ETBinScope
    not lower(input.pipelineAppType) in data.valid_types.valid_pipeline_app_type
    decision := {
        "message": "App type is not application",
        "policy_name": "Enforcement Scope policy",
        "decision": "false",
    }
}

scope_results contains decision if {
    not ETBinScope
    not input.pipelineFlavor in data.scope_flavors
    decision := {
        "message": "Flavor is not in scope",
        "policy_name": "Enforcement Scope policy",
        "decision": "false",
    }
}

scope_results contains decision if {
    not ETBinScope
    out_of_scope_date = true
    decision := {
        "message": "repo is not in scope",
        "policy_name": "Enforcement Scope policy",
        "decision": "false",
    }
}

ETBinScope if {
    lower(input.repoUrl) in data.ETB_list
} else {
    false
}

in_scope_pipeline if {
    lower(input.pipelineAppType) in data.valid_types.valid_pipeline_app_type
    input.pipelineFlavor in data.scope_flavors
    in_scope_date = true
}

in_scope_date if {
    cutoff_time = time.parse_rfc3339_ns(IN_SCOPE_CUTOFF_DATE)
    repo_creation_timestamp >= cutoff_time
}

out_of_scope_date if {
    input.repoCreationDate != ""
    cutoff_time = time.parse_rfc3339_ns(IN_SCOPE_CUTOFF_DATE)
    repo_creation_timestamp < cutoff_time
}

in_scope_date if {
    input.repoCreationDate = ""
}

make_decision(decisions) := result if {
    "false" in decisions
    result := "false"
} else := result if {
    "true" in decisions
    result := "true"
} else := ""




------------------------------


package policy.enforcement.scope_test

import data.policy.enforcement.scope

# Test when the repository is net new and exactly 60 days have passed.
test_net_new_and_fully_enforced {
    creation := "2024-04-02T00:00:00Z"
    
    expected_enforcement := time.format_ns(
        time.add_ns(time.parse_rfc3339_ns(creation), 60 * 24 * 3600 * 1000000000),
        "2006-01-02T15:04:05Z07:00"
    )
    
    input := {
        "repoCreationDate": creation,
        "repoUrl": "dummy_repo",
        "pipelineAppType": "application",
        "pipelineFlavor": "flavorA",
    }
    
    net_new := scope.is_repo_net_new with input as input
    fully_enforced := scope.is_repo_fully_enforced with input as input with policy.enforcement.scope.current_time_ns as time.parse_rfc3339_ns(expected_enforcement)
    full_due := scope.full_enforcement_Date with input as input

    net_new == true
    fully_enforced == true
    full_due == expected_enforcement
}

# Test when the repository is net new but less than 60 days have passed.
test_net_new_but_not_fully_enforced {
    creation := "2024-04-02T00:00:00Z"
    
    expected_enforcement := time.format_ns(
        time.add_ns(time.parse_rfc3339_ns(creation), 60 * 24 * 3600 * 1000000000),
        "2006-01-02T15:04:05Z07:00"
    )
    
    simulated_current := time.add_ns(time.parse_rfc3339_ns(creation), 30 * 24 * 3600 * 1000000000)
    
    input := {
        "repoCreationDate": creation,
        "repoUrl": "dummy_repo",
        "pipelineAppType": "application",
        "pipelineFlavor": "flavorA",
    }
    
    net_new := scope.is_repo_net_new with input as input
    fully_enforced := scope.is_repo_fully_enforced with input as input with policy.enforcement.scope.current_time_ns as simulated_current
    full_due := scope.full_enforcement_Date with input as input

    net_new == true
    fully_enforced == false
    full_due == expected_enforcement
}

# Test when the repository is not net new.
test_not_net_new {
    creation := "2024-03-31T00:00:00Z"
    
    expected_enforcement := time.format_ns(
        time.add_ns(time.parse_rfc3339_ns(creation), 60 * 24 * 3600 * 1000000000),
        "2006-01-02T15:04:05Z07:00"
    )
    
    simulated_current := time.add_ns(time.parse_rfc3339_ns(creation), 70 * 24 * 3600 * 1000000000)
    
    input := {
        "repoCreationDate": creation,
        "repoUrl": "dummy_repo",
        "pipelineAppType": "application",
        "pipelineFlavor": "flavorA",
    }
    
    net_new := scope.is_repo_net_new with input as input
    fully_enforced := scope.is_repo_fully_enforced with input as input with policy.enforcement.scope.current_time_ns as simulated_current
    full_due := scope.full_enforcement_Date with input as input

    net_new == false
    fully_enforced == false
    full_due == expected_enforcement
}



