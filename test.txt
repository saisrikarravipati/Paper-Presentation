###########################################################
# automated_test_validation.rego
#
# Refactored to avoid using 'or' in the rule body.
# Instead, we collect missing test cases in two separate
# partial sets, then unify them.
###########################################################

package policy.enforcement.TMM.automated_test_validation

import data.policy.lib.data
import data.policy.lib.functions.match_test_names
import data.policy.lib.functions.is_empty_or_undefined
import data.policy.lib.functions.in_array
import data.policy.lib.functions.valid_status
import rego.v1

###########################################################
# 1) Dictionary: testCaseId -> set of statuses
###########################################################
sevenps_entry := {
  t.testCaseId: {
    st |
    test_row := input.sevenps_test_cases[_]
    test_row.testCaseId == t.testCaseId
    st := test_row.status
  } |
  t := input.sevenps_test_cases[_]
}

###########################################################
# 2) All JIRA IDs from traceability_data
###########################################################
traceability_jira_ids := {
  tr.jira_id |
  tr := input.traceability_data[_]
}

###########################################################
# 3) Valid traceability data = only items whose jira_id
#    is in input.jira_data
###########################################################
valid_traceability_data := {
  vt |
  vt := input.traceability_data[_]
  vt.jira_id in input.jira_data
}

###########################################################
# 4) Unique test cases from valid_traceability_data
###########################################################
unique_jira_test_cases := {
  testC |
  valid_entry := valid_traceability_data[_]
  testC := valid_entry.test_cases[_]
}

###########################################################
# 5) Gather statuses for each test case.
#    - If no direct match, fallback to regex.
###########################################################

# Exact match
jira_test_case_statuses[test_case] := statuses if {
  test_case := unique_jira_test_cases[_]
  sevenps_entry[test_case]
  statuses := sevenps_entry[test_case]
}

# Regex fallback
jira_test_case_statuses[test_case] := regex_statuses if {
  test_case := unique_jira_test_cases[_]
  not sevenps_entry[test_case]
  regex_statuses := {
    st |
    row := input.sevenps_test_cases[_].testCaseId
    match_test_names(test_case, row)
    st := sevenps_entry[row][_]
  }
}

###########################################################
# 6) Missing JIRA IDs in input.jira_data but not in
#    traceability_jira_ids
###########################################################
missing_jira_ids contains jira_id if {
  jira_id := input.jira_data[_]
  not in_array(traceability_jira_ids, jira_id)
}

###########################################################
# 7) Split "missing or invalid" logic into two partial sets,
#    then unify them in `missing_test_case_id`.
#
#    A) missing_empty_test_cases = cases with empty or
#       undefined statuses
#    B) missing_invalid_test_cases = cases with statuses
#       present but no valid status found
###########################################################
missing_empty_test_cases[test_case] if {
  test_case := unique_jira_test_cases[_]
  is_empty_or_undefined(jira_test_case_statuses[test_case])
}

missing_invalid_test_cases[test_case] if {
  test_case := unique_jira_test_cases[_]
  statuses := jira_test_case_statuses[test_case]
  not is_empty_or_undefined(statuses)
  not valid_status(statuses)
}

# missing_test_case_id = union of both sets
missing_test_case_id contains test_case if {
  missing_empty_test_cases[test_case]
} else {
  missing_invalid_test_cases[test_case]
}

###########################################################
# 8) Final results object
###########################################################

results["missing_id_automated"] := missing_test_case_id if {
  count(missing_test_case_id) > 0
} else := ""

results["missing_jira_ids"] := missing_jira_ids if {
  count(missing_jira_ids) > 0
} else := []

results["decision"] := "PASS" if {
  count(missing_test_case_id) == 0
  count(missing_jira_ids) == 0
} else := "FAIL"

results["total_traceability_tests"] := test_count if {
  test_count := count(unique_jira_test_cases)
} else := 0

results["valid_traceability_tests"] := valid_count if {
  total_count := count(unique_jira_test_cases)
  missing_count := count(missing_test_case_id)
  valid_count := total_count - missing_count
} else := 0
